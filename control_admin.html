<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control IoT | Monitoreo de Sensores</title>
    <link href="css/prueba.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Pegado superior para el header */
      .dashboard-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        background: #fff;
        box-shadow: 0 2px 8px #e0e7ef33;
      }
      .dashboard-content {
        padding-top: 90px; /* Ajusta seg√∫n la altura real del header */
      }
      body {
        margin: 0;
        background: #f8faff;
      }
    </style>
</head>

<body class="dashboard">
  <!-- Loader superior -->
  <div class="top-loader" id="topLoader">
    <div class="bar"></div>
  </div>

    <!-- Barra de navegaci√≥n superior -->
    <header class="dashboard-header">
        <div class="header-container">
            <div class="header-title">
                <h1>Control<span>IoT</span></h1>
            </div>
      <!-- Men√∫: hacerlo completamente est√°tico -->
      <nav class="main-nav" id="mainNav" style="position:static;">
        <ul style="position:static;">
          <!-- Men√∫ para ADMIN -->
          <li class="admin-only" id="navInicioAdmin"><a href="principal_admin.html"><i class="fas fa-home"></i><span>Inicio</span></a></li>
          <li class="admin-only" id="navControlAdmin"><a href="control_admin.html"><i class="fas fa-tachometer-alt"></i><span>Control</span></a></li>
          <li class="admin-only" id="navIOTAdmin"><a href="iot_admin.html"><i class="fas fa-broadcast-tower"></i><span>IoT</span></a></li>
          <li class="admin-only" id="navTablero"><a href="tablero.html"><i class="fas fa-chart-line"></i><span>Tablero</span></a></li>
          <li class="admin-only" id="navUsuarios"><a href="usuarios.html"><i class="fas fa-users-cog"></i><span>Usuarios</span></a></li>
          <li class="admin-only" id="navReportesAdmin"><a href="reportes_admin.html" class="active"><i class="fas fa-file-alt"></i><span>Reportes</span></a></li>

        </ul>
      </nav>

            <div class="user-menu">
                <div class="user-info">
                    <span class="welcome-msg">Bienvenido</span>
                    <span class="username" id="usernameDisplay">Cargando..</span>
                </div>
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user-circle" id="userIcon"></i>
                </div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>
    <!-- Contenido principal -->
    <main class="dashboard-content" id="mainContent">
</section>
        <!-- Encabezado -->
        <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h2 class="section-title"><span>Monitoreo en Tiempo Real</span></h2>
            <div class="section-buttons">
                <button class="refresh-btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> Actualizar</button>
            </div>
        </div>
        <div class="last-update" style="text-align:right;margin-bottom:1rem;">
            <i class="fas fa-clock"></i>
            <span id="last-update-text">√öltima actualizaci√≥n: --:--:--</span>
        </div>
        <!-- Grid de sensores -->
        <div class="sensor-grid" id="sensorGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:2rem;min-height:200px;">
            <!-- Aqu√≠ se renderizan los sensores del usuario -->
        </div>
        <div class="stats-cards" style="display:flex;gap:1rem;justify-content:center;margin:2rem 0;">
            <div class="stat-card">
                <i class="fas fa-microchip"></i>
                <div>
                    <span class="stat-value" id="totalSensores">0</span>
                    <span class="stat-label">Sensores registrados</span>
                </div>
            </div>
        </div>

        <!-- Tarjeta de gr√°fico -->
        <div class="graph-card" id="graphCard">
            <div class="graph-card-header">
                <h4>Gr√°fico del Sensor</h4>
                <button class="close-btn" onclick="cerrarGrafico()"><i class="fas fa-times"></i></button>
            </div>
            <div class="graph-card-body">
                <iframe id="iframeGrafico" src="" frameborder="0" loading="lazy"></iframe>
            </div>
        </div>

        <!-- ‚úÖ Modal Agregar Sensor -->
        <div id="addSensorModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Agregar nuevo sensor</h3>
                    <button class="close-modal" id="closeAddSensorModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addSensorForm">
                        <div class="form-group">
                            <label for="sensorName">Nombre del sensor</label>
                            <input type="text" id="sensorName" name="sensorName" required />
                        </div>
                        <div class="form-group">
                            <label for="sensorId">ID del sensor (1-6)</label>
                            <input type="number" id="sensorId" name="sensorId" min="1" max="6" required />
                        </div>
                        <div class="form-group">
                            <label for="sensorType">Tipo de sensor</label>
                            <select id="sensorType" name="sensorType" required>
                                <option value="temperatura">üå°Ô∏è Temperatura</option>
                                <option value="humedad">üíß Humedad</option>
                                <option value="movimiento">üïπÔ∏è Movimiento</option>
                                <option value="gas">üî• Gas</option>
                                <option value="luz">üí° Luz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sensorUser">Usuario asignado</label>
                            <select id="sensorUser" name="sensorUser" required>
                                <option value="" disabled selected>Seleccione un usuario</option>
                                <!-- Opciones de usuarios se llenan din√°micamente con JS -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <section class="status-cards" style="margin-bottom:1rem;">
          <div class="status-card">
            <div class="status-icon normal"><i class="fas fa-users"></i></div>
            <div class="status-info">
              <span class="status-value" id="totalUsuarios">0</span>
              <span class="status-label">Usuarios registrados</span>
            </div>
          </div>
          <div class="status-card">
            <div class="status-icon online"><i class="fas fa-microchip"></i></div>
            <div class="status-info">
              <span class="status-value" id="totalSensoresUsuario">0</span>
              <span class="status-label">Sensores (usuario seleccionado)</span>
            </div>
          </div>
          <div class="status-card">
            <div class="status-icon normal"><i class="fas fa-bolt"></i></div>
            <div class="status-info">
              <span class="status-value" id="accionesHoy">0</span>
              <span class="status-label">Acciones hoy</span>
            </div>
          </div>
          <div class="status-card">
            <div class="status-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="status-info">
              <span class="status-value" id="alertasActivas">0</span>
              <span class="status-label">Alertas activas</span>
            </div>
          </div>
        </section>

        <!-- SECCI√ìN DE USUARIOS ADMINISTRABLES (SIEMPRE VISIBLE PARA ADMIN) -->
        <section id="usuariosAdminSection" style="margin-bottom:2rem; display:block;">
          <div class="section-header">
            <h3><i class="fas fa-users-cog"></i> Usuarios y Sensores</h3>
            <div class="search-box">
              <input id="userSearch" type="text" placeholder="Buscar usuario..." />
              <button class="search-btn" id="userSearchBtn"><i class="fas fa-search"></i></button>
            </div>
          </div>
          <div style="overflow-x:auto;">
            <table id="usuariosTable" class="usuarios-table" style="width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="usuariosTableBody">
                <!-- Las filas de usuario se renderizan aqu√≠ por JS -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- MODAL ADMINISTRAR USUARIO Y SENSORES -->
        <div id="adminUsuarioModal" class="modal">
          <div class="modal-content" style="max-width:700px;">
            <div class="modal-header" style="background:#4361ee;color:#fff;">
              <h3 style="margin:0;">Administrar usuario: <span id="adminUsuarioNombre"></span></h3>
              <button class="close-modal" onclick="cerrarAdminUsuarioModal()" style="color:#fff;">&times;</button>
            </div>
            <div class="modal-body" style="background:#f8faff;">
              <h4 style="margin-bottom:1.2rem;color:#4361ee;">Sensores del usuario</h4>
              <div id="sensoresUsuarioList" class="sensores-usuario-list" style="margin-bottom:2rem;">
                <!-- Aqu√≠ se listan los sensores con controles -->
              </div>
              <hr style="margin:2rem 0 1.2rem 0;">
              <div style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #4361ee22;padding:1.2rem;">
                <h4 style="margin-bottom:.8rem;color:#4361ee;">Agregar sensor a este usuario</h4>
                <form id="adminAddSensorForm" style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">
                  <div class="form-group" style="flex:1;min-width:180px;">
                    <label for="adminSensorName">Nombre del sensor</label>
                    <input id="adminSensorName" type="text" required style="width:100%;" />
                  </div>
                  <div class="form-group" style="flex:0.5;min-width:110px;">
                    <label for="adminSensorRef">ID del sensor</label>
                    <select id="adminSensorRef" required style="width:100%;">
                      <option value="" disabled selected>Seleccione ID</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                    </select>
                  </div>
                  <div class="form-group" style="flex:1;min-width:180px;">
                    <label for="adminSensorTipo">Tipo de sensor</label>
                    <select id="adminSensorTipo" required style="width:100%;">
                      <option value="" disabled selected>Seleccione tipo</option>
                      <!-- Opciones din√°micas por JS -->
                    </select>
                  </div>
                  <div>
                    <button type="submit" class="btn btn-primary" style="padding:.7rem 1.5rem;"><i class="fas fa-plus"></i> Agregar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
    </main>

    <!-- Modal de Historial -->
    <div class="modal" id="historialModal">
        <!-- tu modal original -->
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
        <!-- tu chatbot original -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.16/dist/sweetalert2.all.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/tipo_sensor.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/usuarios.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/control.js"></script>
    <script src="js/admin_control.js"></script>
    <script>
      // --- Limpieza de la grilla de sensores antes de renderizar nuevos ---
      // Suponiendo que tienes una funci√≥n renderSensores(sensores)
      function renderSensores(sensores) {
        const grid = document.getElementById('sensorGrid');
        grid.innerHTML = ''; // Limpia la grilla antes de renderizar
        sensores.forEach(sensor => {
          // ...renderiza cada sensor como antes...
          // grid.appendChild(sensorElement);
        });
      }

      // Si usas otra funci√≥n para actualizar sensores, aseg√∫rate de limpiar el grid antes de agregar nuevos elementos.
      // Por ejemplo, en el evento de actualizaci√≥n:
      document.getElementById('refresh-btn').addEventListener('click', function() {
        // ...c√≥digo para obtener sensores...
        // renderSensores(nuevosSensores);
      });
    </script>
</body>
</html>
